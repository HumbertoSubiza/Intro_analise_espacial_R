---
title: "Terra_SpatRaster1"
author: "Walter Humberto Subiza Piña"
date: "2023-07-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo      = TRUE, 
                      warning   = FALSE, 
                      message   = FALSE, 
                      fig.path  = paste0(getwd(), "/figuras/"), 
                      fig.ext   = 'png',
                      fig.align = 'center')
```



```{r biblio}
library(terra)
```


### 1- Clase SpatRaster

Direccionamiento para la pasta donde se encuentran los datos a ser cargados.


```{r camino}
cam <- ("C:/Users/Administrador/Documents/R/Intro_analise_espacial_R/exercicios/data")

```

\

El primer tópico a ser abordado es la creación de objetos raster. Un objeto raster representa uma superfície contínua que está georreferenciada y posee 3 dimensiones, lineas, columnas y camadas. Las lineas y columnas dividen el espacio en cuadrículas (o formas geométricas diferentes) y las diversas camadas representan valores de un determinado atributo en cada célula. Un ejemplo típico seria um modelo digital de terreno (MDT o DTM en inglés) en que cada célula (linea y columna) tiene asociada una determinada altitud. El tamaño de la célula se denomina resolución del MDT y representa un determinado espacio de terreno.

Con _terra_ podemos crear estos objetos raster a partir de un archivo ya existente, a partir de otro objeto o a partir de cero, o sea sin contar con datos preexistentes.

La forma mas rápida y común es a partir de un archivo ya existente, que puede ser un MDT o una imagen aérea o satelital.

\

A continuación vamos a cargar un archivo de altitudes del tipo tif, de la base de datos de SRTM <https://www2.jpl.nasa.gov/srtm/>, para eso agregamos al camino de los datos, el nombre del archivo y luego se carga con el métoso _rast_. A continuación generamos un gráfico del mismo, la escala de colores y los ejes son automáticamente escogidos.


```{r intro1}
# camino + nombre del archivo 
f1<- (paste(cam,"srtm_26_19.tif",sep = "/"))
# cargar el archivo
r1 <- rast(f1) 
# imagen
plot(r1)
```

Para verificar el sistema geodésico de referencia (_CRS, Coordinate Reference System_), la extensión de los datos cargados, la resolución espacial y ver las 4 primeras lineas del archivo:

```{r intro2}
# SGR
crs(r1, proj=TRUE)
# extensión
ext(r1)
# resolución en grados decimales, debido al SGR
res(r1)
# primeras cuatro lineas del objeto
head(r1,4)
```

Verificamos que el SGR es WGS84, en coordenadas geográficas de latitud y longitud y la resolución en grados decimales es 0,0008333, que corresponde aproximadamente a 90 m. El archivo es del tipo dataframe.


Cargamos otro archivo semejante, en este caso hacemos la carga directamente con el nombre del archivo.

```{r intro3}
# cargar el archivo
r2 <- rast(paste(cam,"srtm_26_18.tif",sep = "/")) 
# imagen
plot(r2)

```


Podemos unir los dos archivos, que tienen el mismo SGR y resolución, usando el método _merge_. A su vez podemos ver las estadísticas del archivo final con _summary_.

```{r intro4}
# unión de los archivos
R <-merge(r1,r2)
# estatísticas
summary(R)
# gráfico
plot(R)
```


\

Com base en las estatísticas, también podemos hacer una clasificación del atributo altitud, por ejemplo:

```{r intro5}
d <- classify(R, c(-7,0,50,100,250,500, 1000, 1530))
plot(d, type="classes")
north(cbind(-54, -27))
```

\


Los archivos cargados y unidos están en coordenadas geográficas, podemos proyectarlo para un sistema plano como UTM, de la siguiente forma:


```{r intro6}
nuevo_crs <- "+proj=utm +zone=22 +south +datum=WGS84 +units=m +no_defs +type=crs"
Rp <- project((R), nuevo_crs)
```


```{r intro7}
# verificando el SGR
crs(Rp, proj=TRUE)
# resolución
res(Rp)
# estatísticas del archivo
summary(Rp)
# gráfico
plot(Rp)
```

Como mencionamos en la introducción, los objetos creados de clase **SpatRaster** en una sesión son temporarios y una vez cerrada la sesión no es posible recuperarlos. Para conservar un objeto y recuperarlos en sesiones posteriores, debemos grabarlo, de la siguiente forma.

```{r intro8}
# verificar el camino de grabación
f <- file.path("C:/Users/Administrador/Documents/R/Intro_analise_espacial_R/exercicios/data")
```

```{r intro9}
f <- file.path("~/R/Intro_analise_espacial_R/exercicios/data/uru_bras.tif")
# grabar
writeRaster(Rp,f, overwrite=TRUE)
```


\

A continuación vamos a cargar dos imagenes de satélite: una **Landsat** tipo _tif_, de tres bandas RGB y una **Sentinel** también con la combinación RGB, pero de formato _jp2_.


```{r intro10}
# camino + nombre del archivo Landsat
f3<- (paste(cam,"landsat.tif",sep = "/"))
# cargar el archivo
r3 <- rast(f3) 
# imagen
plot(r3)
```

En ester caso, el método _plot_ genera tres gráficos, correspondiendo a cada banda que contiene el archivo. Para poder crear un gráfico de la composición RGB se debe usar el método _plotRGB_ con algunas opciones.


```{r intro11}
res(r3)
nlyr(r3)
names(r3)
plotRGB(r3, r=1, g=2, b=3, a=NULL, colNA="white",stretch="lin", smooth=TRUE, axes=TRUE)
```

\

El archivo Sentinel es cargado y el método _plot_ genera automáticamente la combinación de RGB correspondiente. Nota: ela imagen anterior y esta, corresponden a áreas diferentes.


```{r intro12}
# cargar el archivo
r4 <- rast((paste(cam,"sent_20230716.jp2",sep = "/"))) 
# imagen
plot(r4)
```



```{r intro13}
crs(r4, proj=TRUE)
ext(r4)
res(r4)
nlyr(r4)
names(r4)
head(r4)
```

\

Verificamos que el sistema geodésico es UTM, huso 21, la extensión de la imagen, la resolución de 10 m y que el archivo contiene 2 bandas o camadas (RGB).

Es importante recordar que al leer estos archivos, no se cargan los valores de las células en la memoria de la computadora. Los archivos ráster pueden tener un tamaño grande y, para conservar la memoria, los datos se leen cuando es necesario.

En el siguiente código, vemos el tamaño del archivo raster de **Sentinel** en la memoria y en el disco.

```{r intro14}
# Tamaño en memoria
object.size(r4)
# Tamaño en disco
file.size("~/R/Intro_analise_espacial_R/exercicios/data/sent_20230716.jp2")
```

